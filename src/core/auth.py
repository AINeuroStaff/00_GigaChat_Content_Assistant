"""
Проект: GigaChat_Content_Assistant
Версия: 1.0
Статус: Первая deploy версия

Модуль: src/core/auth.py
Разработчик: GEN AI + @AI_NeuroStaff / Dubinin Vladimir

Authentication Service: Глобальная защита приложения
====================================================

Модуль отвечает за безопасность и авторизацию пользователей в приложении.
Использует библиотеку `streamlit-authenticator` (совместимо с версиями 0.4.x+).
Обеспечивает чтение учетных данных из защищенных переменных окружения, 
динамическое криптографическое хеширование паролей "на лету" и настройку 
cookies для сохранения сессии пользователя (чтобы не вводить пароль при каждом входе).

Основные возможности:
- Безопасная загрузка параметров доступа из .env или системных переменных.
- Формирование конфигурационного словаря (credentials) по стандарту библиотеки.
- Автоматическое хеширование открытых паролей в bcrypt перед инициализацией.
- Создание и возврат готового инстанса аутентификатора.

Переменные:
- Внешние (Переменные окружения):
    - SETTINGS_USERNAME: Логин администратора (по умолчанию 'admin').
    - SETTINGS_PASSWORD: Пароль администратора (по умолчанию 'super_secret_password').
    - AUTH_COOKIE_KEY: Уникальная подпись для защиты cookie от подделки.
- Внутренние (локальные):
    - config: Словарь, содержащий структуру пользователей и настройки сессии (cookies).

Функции:
- get_authenticator() -> stauth.Authenticate
    Главная фабричная функция модуля. Собирает конфигурацию, хеширует пароли 
    внутри словаря 'credentials' и возвращает готовый к использованию 
    объект аутентификатора.

Связи с другими модулями:
- main.py:
    Вызывает get_authenticator() в самом начале для блокировки интерфейса 
    до успешного входа пользователя и для отображения кнопки "Выйти" (logout).
"""

import os
import streamlit as st
import streamlit_authenticator as stauth

def get_authenticator() -> stauth.Authenticate:
    """
    Инициализирует и возвращает объект аутентификатора.
    Загружает учетные данные из .env и безопасно хеширует их.
    """
    # ==========================================
    # 1. Получаем учетные данные из окружения (или используем дефолтные для тестов)
    # ==========================================
    username = os.getenv("SETTINGS_USERNAME", "admin")
    password_plaintext = os.getenv("SETTINGS_PASSWORD", "super_secret_password")
    cookie_key = os.getenv("AUTH_COOKIE_KEY", "content_ai_secure_signature_must_be_32_bytes_long")

    # ==========================================
    # 2. Формируем структуру конфигурации с ОТКРЫТЫМ паролем
    # ==========================================
    # (Структура адаптирована под новые версии streamlit-authenticator 0.4+)
    config = {
        'credentials': {
            'usernames': {
                username: {
                    'email': 'admin@content-ai.local',
                    'name': 'Администратор',
                    'password': password_plaintext 
                }
            }
        },
        'cookie': {
            'expiry_days': 30,             # Время жизни сессии в днях
            'key': cookie_key,             # Секретный ключ для шифрования куки
            'name': 'content_ai_auth_cookie' # Имя файла куки в браузере
        }
    }

    # ==========================================
    # 3. Хешируем пароли прямо внутри словаря конфигурации
    # ==========================================
    # Метод hash_passwords автоматически находит ключи 'password' и заменяет их на bcrypt-хеш
    stauth.Hasher.hash_passwords(config['credentials'])

    # ==========================================
    # 4. Создаем инстанс аутентификатора (передаем только 4 аргумента)
    # ==========================================
    authenticator = stauth.Authenticate(
        config['credentials'],
        config['cookie']['name'],
        config['cookie']['key'],
        config['cookie']['expiry_days']
    )
    
    return authenticator