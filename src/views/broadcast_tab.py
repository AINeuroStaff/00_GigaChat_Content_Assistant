"""
–ü—Ä–æ–µ–∫—Ç: GigaChat_Content_Assistant
–í–µ—Ä—Å–∏—è: 1.0
–°—Ç–∞—Ç—É—Å: –ü–µ—Ä–≤–∞—è deploy –≤–µ—Ä—Å–∏—è

–ú–æ–¥—É–ª—å: src/views/broadcast_tab.py
–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: GEN AI + @AI_NeuroStaff / Dubinin Vladimir

Broadcast Tab: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ –∏ —Ä–∞—Å—Å—ã–ª–æ–∫
==========================================

–ú–æ–¥—É–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (Streamlit Page) –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
–ø–æ–¥ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ (Telegram, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ, Email-—Ä–∞—Å—Å—ã–ª–∫–∏ –∏ —Ç.–¥.).

–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –í—ã–±–æ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–º, —Ä–∞–Ω–µ–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω" (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ session_state).
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Tone of Voice (—Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏) –∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –±—Ä–µ–Ω–¥–∞.
- –ü–æ—Ç–æ–∫–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (streaming) –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç LLM –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É–ø–∞–∫–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –≤ –µ–¥–∏–Ω—ã–π ZIP-–∞—Ä—Ö–∏–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
- –í–Ω–µ—à–Ω–∏–µ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ): 
    - st.session_state.generated_topics: —Å–ø–∏—Å–æ–∫ —Ç–µ–º, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –∏–∑ –≤–∫–ª–∞–¥–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞.
    - st.session_state.current_niche: —Ç–µ–∫—É—â–∞—è –Ω–∏—à–∞ –±–∏–∑–Ω–µ—Å–∞.
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ (–ª–æ–∫–∞–ª—å–Ω—ã–µ):
    - selected_channels: —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º.
    - generated_results: —Å–ª–æ–≤–∞—Ä—å, —Ö—Ä–∞–Ω—è—â–∏–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã (–∫–∞–Ω–∞–ª -> —Ç–µ–∫—Å—Ç).
    - zip_data: –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ZIP-–∞—Ä—Ö–∏–≤–∞, –≥–æ—Ç–æ–≤—ã–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.

–§—É–Ω–∫—Ü–∏–∏:
- create_zip_archive(data_dict: dict) -> bytes
    –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å —Ç–µ–∫—Å—Ç–∞–º–∏, —Å–æ–∑–¥–∞–µ—Ç ZIP-–∞—Ä—Ö–∏–≤ –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ 
    (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ –¥–∏—Å–∫) –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ –±–∞–π—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.
- render_broadcast_tab() -> None
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –°–æ–∑–¥–∞–µ—Ç –¥–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π layout (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã), 
    –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–º –≤—ã–∑–æ–≤–∞ LLM.

–°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏:
- src.services.content_gen:
    - generate_broadcast_stream(): –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–∞–Ω–∞–ª.
- main.py:
    - –ü–æ–¥–∫–ª—é—á–∞–µ—Ç —ç—Ç–æ—Ç —Ñ–∞–π–ª –∫–∞–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ st.Page().
"""

import streamlit as st
from datetime import datetime
import io
import zipfile

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
from src.services.content_gen import generate_broadcast_stream

# ==========================================
# --- 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –£–¢–ò–õ–ò–¢–´ ---
# ==========================================
def create_zip_archive(data_dict: dict) -> bytes:
    """
    –°–æ–∑–¥–∞–µ—Ç ZIP-–∞—Ä—Ö–∏–≤ –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ –∏–∑ —Å–ª–æ–≤–∞—Ä—è —Å—Ç—Ä–æ–∫.
    
    Args:
        data_dict (dict): –°–ª–æ–≤–∞—Ä—å, –≥–¥–µ –∫–ª—é—á ‚Äî –∏–º—è –∫–∞–Ω–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'Telegram'), 
                          –∞ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞.
                          
    Returns:
        bytes: –ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ZIP-–∞—Ä—Ö–∏–≤–∞.
    """
    zip_buffer = io.BytesIO()
    with zipfile.ZipFile(zip_buffer, "w", zipfile.ZIP_DEFLATED) as zip_file:
        for filename, content in data_dict.items():
            # –§–æ—Ä–º–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, telegram.txt)
            safe_name = f"{filename.lower().replace(' ', '_')}.txt"
            zip_file.writestr(safe_name, content)
    return zip_buffer.getvalue()

def render_broadcast_tab() -> None:
    """–û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–∫–ª–∞–¥–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞—Å—Å—ã–ª–æ–∫ –∏ –ø–æ—Å—Ç–æ–≤."""
    st.title("‚úâÔ∏è –†–∞—Å—Å—ã–ª–∫–∏ –∏ –°–æ—Ü—Å–µ—Ç–∏")
    st.markdown("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ –∏ email-—Ä–∞—Å—Å—ã–ª–æ–∫ –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Å —É—á–µ—Ç–æ–º Tone of Voice.")

    # –°–æ–∑–¥–∞–µ–º –¥–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π –º–∞–∫–µ—Ç: —Å–ª–µ–≤–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (1 —á–∞—Å—Ç—å —à–∏—Ä–∏–Ω—ã), —Å–ø—Ä–∞–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (2.5 —á–∞—Å—Ç–∏)
    col_settings, col_results = st.columns([1, 2.5])

   
    # ==========================================
    # --- 2. –ò–ù–¢–ï–†–§–ï–ô–° –ù–ê–°–¢–†–û–ï–ö ---
    # ==========================================
    with col_settings:
        st.subheader("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Å—Ç–∞")
        with st.form("broadcast_settings"):
            # –ë–µ—Ä–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –Ω–∏—à—É –∏–∑ —Å–µ—Å—Å–∏–∏ –∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π
            niche = st.text_input("–ù–∏—à–∞ –±–∏–∑–Ω–µ—Å–∞", value=st.session_state.get("current_niche", ""))
            
            # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–æ–º: –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Ç–µ–º—ã, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —Ä–∞–Ω–µ–µ
            saved_topics = st.session_state.get("generated_topics", [])
            if saved_topics:
                topic = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –∏–∑ –ø–ª–∞–Ω–∞:", ["-- –°–≤–æ—è —Ç–µ–º–∞ --"] + saved_topics)
                if topic == "-- –°–≤–æ—è —Ç–µ–º–∞ --":
                    topic = st.text_input("–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é —Ç–µ–º—É:")
            else:
                topic = st.text_input("–¢–µ–º–∞ –ø–æ—Å—Ç–∞/–ø–∏—Å—å–º–∞:")
            
            tone = st.selectbox(
                "Tone of Voice (–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)",
                ["–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –≤–æ–≤–ª–µ–∫–∞—é—â–∏–π", "–°—Ç—Ä–æ–≥–∏–π –∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π", "–ü—Ä–æ–¥–∞—é—â–∏–π (AIDA)", "–Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π"]
            )
            
            channels = st.multiselect(
                "–ö–∞–Ω–∞–ª—ã —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è",
                ["Telegram", "–í–ö–æ–Ω—Ç–∞–∫—Ç–µ", "Email-—Ä–∞—Å—Å—ã–ª–∫–∞", "–î–∑–µ–Ω", "Instagram/Facebook (Meta)"],
                default=["Telegram"]
            )
            
            brand_keywords = st.text_input("–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞/—Ö–µ—à—Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):")

            generate_btn = st.form_submit_button("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å üöÄ", use_container_width=True)

    # ==========================================
    # --- 3. –ì–ï–ù–ï–†–ê–¶–ò–Ø –ò –í–´–í–û–î –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ---
    # ==========================================
    
    with col_results:
        # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è-–∑–∞–≥–ª—É—à–∫–∞ –¥–æ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
        if not generate_btn:
            st.info("üëà –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–ª–µ–≤–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª, —á—Ç–æ–±—ã AI –Ω–∞—á–∞–ª —Ä–∞–±–æ—Ç—É.")
            
        if generate_btn:
            if not topic.strip():
                st.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É –ø–æ—Å—Ç–∞.")
            elif not channels:
                st.error("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–∞–Ω–∞–ª —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è.")
            else:
                # –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
                generated_results = {}
                
                # –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞, —á—Ç–æ–±—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ —Å–ª–∏–≤–∞–ª–∏—Å—å –≤ –æ–¥–Ω—É "–ø—Ä–æ—Å—Ç—ã–Ω—é"
                tabs = st.tabs(channels)
                
                for i, channel in enumerate(channels):
                    with tabs[i]:
                        st.markdown(f"### –í–µ—Ä—Å–∏—è –¥–ª—è: {channel}")
                        
                        # –í—ã–∑—ã–≤–∞–µ–º –ø–æ—Ç–æ–∫–æ–≤—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
                        stream = generate_broadcast_stream(
                            channel=channel,
                            business_niche=niche,
                            topic=topic,
                            tone=tone,
                            brand_keywords=brand_keywords
                        )
                        
                        # st.write_stream –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –ø–æ—Ç–æ–∫ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç
                        full_text = st.write_stream(stream)
                        generated_results[channel] = full_text
                        
                        # –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
                        st.toast(f"–ü–æ—Å—Ç –¥–ª—è {channel} —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!", icon="‚úÖ")

                # ==========================================
                # --- 4. –≠–ö–°–ü–û–†–¢ –†–ï–ó–£–õ–¨–¢–ê–¢–û–í (ZIP-–ê–†–•–ò–í) ---
                # ==========================================
                
                if generated_results:
                    st.markdown("---")
                    # –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç—ã –≤ –∞—Ä—Ö–∏–≤
                    zip_data = create_zip_archive(generated_results)
                    
                    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç—ã –∏ –æ—á–∏—â–µ–Ω–Ω–æ–π —Ç–µ–º—ã
                    timestamp = datetime.now().strftime("%Y%m%d_%H%M")
                    safe_topic = "".join([c if c.isalnum() else "_" for c in topic])[:15]
                    zip_filename = f"campaign_{safe_topic}_{timestamp}.zip"
                    
                    # –†–∞–∑–º–µ—â–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É
                    col_dl1, col_dl2, col_dl3 = st.columns([1, 2, 1])
                    with col_dl2:
                        st.download_button(
                            label="üì¶ –°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ç–µ–∫—Å—Ç—ã –∞—Ä—Ö–∏–≤–æ–º (.zip)",
                            data=zip_data,
                            file_name=zip_filename,
                            mime="application/zip",
                            use_container_width=True
                        )

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã Streamlit
render_broadcast_tab()