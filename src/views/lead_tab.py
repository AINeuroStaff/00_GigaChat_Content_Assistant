"""
–ü—Ä–æ–µ–∫—Ç: GigaChat_Content_Assistant
–í–µ—Ä—Å–∏—è: 1.0
–°—Ç–∞—Ç—É—Å: –ü–µ—Ä–≤–∞—è deploy –≤–µ—Ä—Å–∏—è

–ú–æ–¥—É–ª—å: src/views/lead_tab.py
–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: GEN AI + @AI_NeuroStaff / Dubinin Vladimir

Lead Magnet Tab: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–æ–≤ –∏ PDF
=============================================

–ú–æ–¥—É–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (Streamlit Page) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–º–Ω—ã—Ö 
—ç–∫—Å–ø–µ—Ä—Ç–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (—á–µ–∫-–ª–∏—Å—Ç—ã, –≥–∞–π–¥—ã, –º–∏–Ω–∏-–∫–Ω–∏–≥–∏), –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è 
–¥–ª—è —Å–±–æ—Ä–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ (–ª–∏–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏).

–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–∞: —Ç–∏–ø, –∞—É–¥–∏—Ç–æ—Ä–∏—è, –æ–±—ä–µ–º, –Ω–∏—à–∞.
- –ü–æ—Ç–æ–∫–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (streaming) —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ—Ü–µ—Å—Å–∞.
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–µ—Ä—Å—Ç–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ Markdown-—Ç–µ–∫—Å—Ç–∞ –≤ PDF-–¥–æ–∫—É–º–µ–Ω—Ç.
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ PDF –≤ —Å–µ—Å—Å–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
- –í–Ω–µ—à–Ω–∏–µ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ):
    - st.session_state.current_niche: —Ç–µ–∫—É—â–∞—è –Ω–∏—à–∞ –±–∏–∑–Ω–µ—Å–∞ (–¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è).
    - st.session_state.current_pdf_bytes: –∫—ç—à –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ PDF.
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ (–ª–æ–∫–∞–ª—å–Ω—ã–µ):
    - lm_type: –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–∞ (—á–µ–∫-–ª–∏—Å—Ç, –≥–∞–π–¥ –∏ —Ç.–¥.).
    - topic, audience, length: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (—Ç–µ–º–∞, –¶–ê, –æ–±—ä–µ–º).
    - full_text: –ø–æ–ª–Ω—ã–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç LLM.

–§—É–Ω–∫—Ü–∏–∏:
- render_lead_tab() -> None
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –£–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º–æ–π –Ω–∞—Å—Ç—Ä–æ–µ–∫,
    –≤—ã–∑—ã–≤–∞–µ—Ç –ø–æ—Ç–æ–∫–æ–≤—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ–∫—Å—Ç–∞, –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç —Å–±–æ—Ä–∫—É PDF –∏ –≤—ã–≤–æ–¥–∏—Ç –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.

–°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏:
- src.services.content_gen:
    - generate_lead_magnet_stream(): –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
- src.services.pdf_maker:
    - generate_pdf(): –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ –±–∞–π—Ç—ã PDF.
- main.py:
    - –ü–æ–¥–∫–ª—é—á–∞–µ—Ç —ç—Ç–æ—Ç —Ñ–∞–π–ª –∫–∞–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ st.Page().
"""

import streamlit as st

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏ –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä PDF
from src.services.content_gen import generate_lead_magnet_stream
from src.services.pdf_maker import generate_pdf

# ==========================================
# --- 1. –ì–õ–ê–í–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° –í–ö–õ–ê–î–ö–ò ---
# ==========================================

def render_lead_tab() -> None:
    """–û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–∫–ª–∞–¥–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–æ–≤."""
    st.title("üéÅ –õ–∏–¥-–º–∞–≥–Ω–∏—Ç—ã (PDF)")
    st.markdown("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–µ–∑–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è —Å–±–æ—Ä–∞ –±–∞–∑—ã (—á–µ–∫-–ª–∏—Å—Ç—ã, –≥–∞–π–¥—ã) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–µ—Ä—Å—Ç–∫–æ–π –≤ PDF.")

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è PDF –≤ —Å–µ—Å—Å–∏–∏, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç.
    # –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —Ç–∞–∫ –∫–∞–∫ Streamlit –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ download_button.
    if "current_pdf_bytes" not in st.session_state:
        st.session_state.current_pdf_bytes = None

    # –°–æ–∑–¥–∞–µ–º –¥–≤—É—Ö–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π –º–∞–∫–µ—Ç: —Å–ª–µ–≤–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (1 —á–∞—Å—Ç—å), —Å–ø—Ä–∞–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (2.5 —á–∞—Å—Ç–∏)
    col_settings, col_results = st.columns([1, 2.5])

    # ==========================================
    # --- 2. –ò–ù–¢–ï–†–§–ï–ô–° –ù–ê–°–¢–†–û–ï–ö ---
    # ==========================================
    # --- –ö–û–õ–û–ù–ö–ê –ù–ê–°–¢–†–û–ï–ö ---
    with col_settings:
        st.subheader("–ü–∞—Ä–∞–º–µ—Ç—Ä—ã")
        with st.form("lead_magnet_settings"):
            lm_type = st.selectbox(
                "–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞",
                ["–ì–∞–π–¥", "–ß–µ–∫-–ª–∏—Å—Ç", "–ú–∏–Ω–∏-–∫—É—Ä—Å", "–ü–∞–º—è—Ç–∫–∞ (Handbook)"]
            )
            
            niche = st.text_input("–ù–∏—à–∞ –±–∏–∑–Ω–µ—Å–∞", value=st.session_state.get("current_niche", ""))
            
            audience = st.text_area(
                "–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è",
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –º–∞–º—ã –≤ –¥–µ–∫—Ä–µ—Ç–µ, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ IT-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã, –≤–ª–∞–¥–µ–ª—å—Ü—ã –∫–æ—Ñ–µ–µ–Ω..."
            )
            
            length = st.selectbox(
                "–ñ–µ–ª–∞–µ–º—ã–π –æ–±—ä–µ–º",
                ["–ö—Ä–∞—Ç–∫–æ (1-2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã)", "–ü–æ–¥—Ä–æ–±–Ω–æ (3-5 —Å—Ç—Ä–∞–Ω–∏—Ü)", "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ (–æ—Ç 5 —Å—Ç—Ä–∞–Ω–∏—Ü)"]
            )

            # –í—ã–±–æ—Ä —Ç–µ–º—ã
            saved_topics = st.session_state.get("generated_topics", [])
            if saved_topics:
                topic = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É:", ["-- –°–≤–æ—è —Ç–µ–º–∞ --"] + saved_topics)
                if topic == "-- –°–≤–æ—è —Ç–µ–º–∞ --":
                    topic = st.text_input("–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é —Ç–µ–º—É:")
            else:
                topic = st.text_input("–¢–µ–º–∞ –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–∞:")

            generate_btn = st.form_submit_button("–°–æ–∑–¥–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª üöÄ", width='stretch')


    # ==========================================
    # --- 3. –ì–ï–ù–ï–†–ê–¶–ò–Ø –¢–ï–ö–°–¢–ê –ò –°–ë–û–†–ö–ê PDF ---
    # ==========================================
    
    with col_results:
        # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è-–∑–∞–≥–ª—É—à–∫–∞
        if not generate_btn and not st.session_state.current_pdf_bytes:
            st.info("üëà –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ–∑–¥–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª¬ª.")
            
        if generate_btn:
            if not topic.strip():
                st.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≥–ª–∞–≤–Ω—É—é —Ç–µ–º—É –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–∞.")
            else:
                st.markdown("### –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç")
                
                # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫–æ–≤—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ–∫—Å—Ç–∞
                stream = generate_lead_magnet_stream(
                    lm_type=lm_type,
                    topic=topic,
                    audience=audience,
                    length=length,
                    business_niche=niche
                )
                
                # –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ—Ç–æ–∫ –≤ UI –∏ –ø–æ–ª—É—á–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ç–µ–∫—Å—Ç
                full_text = st.write_stream(stream)
                
                # –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É PDF "–Ω–∞ –ª–µ—Ç—É"
                with st.spinner("üì¶ –í–µ—Ä—Å—Ç–∫–∞ PDF-–¥–æ–∫—É–º–µ–Ω—Ç–∞..."):
                    try:
                        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Markdown –≤ PDF —á–µ—Ä–µ–∑ ReportLab
                        pdf_bytes = generate_pdf(title=topic, sections=[full_text])
                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Å–µ—Å—Å–∏—é, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –ø—Ä–æ–ø–∞–ª –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                        st.session_state.current_pdf_bytes = pdf_bytes
                        st.success("‚úÖ –õ–∏–¥-–º–∞–≥–Ω–∏—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–≤–µ—Ä—Å—Ç–∞–Ω!")
                    except Exception as e:
                        st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: {str(e)}")

        # ==========================================
        # --- 4. –ö–ù–û–ü–ö–ê –°–ö–ê–ß–ò–í–ê–ù–ò–Ø ---
        # ==========================================
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è, –µ—Å–ª–∏ PDF —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –ª–µ–∂–∏—Ç –≤ –∫—ç—à–µ —Å–µ—Å—Å–∏–∏
        if st.session_state.current_pdf_bytes:
            st.markdown("---")
            col_pdf1, col_pdf2 = st.columns([1, 1])
            with col_pdf1:
                st.download_button(
                    label="üì• –°–∫–∞—á–∞—Ç—å –ª–∏–¥-–º–∞–≥–Ω–∏—Ç (PDF)",
                    data=st.session_state.current_pdf_bytes,
                    file_name="lead_magnet.pdf",
                    mime="application/pdf",
                    type="primary",
                    width='stretch',
                    key="lead_magnet_download_btn"  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫ Streamlit
                )

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã Streamlit
render_lead_tab()