"""
–ü—Ä–æ–µ–∫—Ç: GigaChat_Content_Assistant
–í–µ—Ä—Å–∏—è: 1.0
–°—Ç–∞—Ç—É—Å: –ü–µ—Ä–≤–∞—è deploy –≤–µ—Ä—Å–∏—è

–ú–æ–¥—É–ª—å: src/views/plan_tab.py
–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: GEN AI + @AI_NeuroStaff / Dubinin Vladimir

Content Plan Tab: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞—Ç—Ä–∏—á–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞
=====================================================

–ú–æ–¥—É–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (Streamlit Page) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ
—Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π. –Ø–≤–ª—è–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–Ω–æ–π —Ç–æ—á–∫–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–¥–µ—Å—å
—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö (–†–∞—Å—Å—ã–ª–∫–∏, –õ–∏–¥-–º–∞–≥–Ω–∏—Ç—ã).

–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–ª–∞–Ω–∞ (–Ω–∏—à–∞, –ø–µ—Ä–∏–æ–¥, –∫–∞–Ω–∞–ª—ã, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç).
- –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ LLM —Å –∂–µ—Å—Ç–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –æ—Ç–≤–µ—Ç–∞ (–æ–∂–∏–¥–∞–µ—Ç—Å—è JSON-–º–∞—Å—Å–∏–≤).
- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –≤–∏–¥–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã (Pandas DataFrame).
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–º –≤ session_state –¥–ª—è –∫—Ä–æ—Å—Å-–º–æ–¥—É–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.
- –≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞ –≤ CSV, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è Microsoft Excel (utf-8-sig).

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
- –í–Ω–µ—à–Ω–∏–µ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ):
    - st.session_state.content_plan: —Ö—Ä–∞–Ω–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω.
    - st.session_state.generated_topics: —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–º –¥–ª—è –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫.
    - st.session_state.current_niche: —Ç–µ–∫—É—â–∞—è –Ω–∏—à–∞ –±–∏–∑–Ω–µ—Å–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è).
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ (–ª–æ–∫–∞–ª—å–Ω—ã–µ):
    - df: –æ–±—ä–µ–∫—Ç pandas.DataFrame –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç–∞–±–ª–∏—Ü—ã.

–§—É–Ω–∫—Ü–∏–∏:
- render_plan_tab() -> None
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –£–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º–æ–π –Ω–∞—Å—Ç—Ä–æ–µ–∫,
    –≤—ã–∑—ã–≤–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∏ –≤—ã–≤–æ–¥–∏—Ç —Ç–∞–±–ª–∏—Ü—É.

–°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏:
- src.services.content_gen:
    - generate_content_plan(): –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ (Pydantic).
- main.py:
    - –ü–æ–¥–∫–ª—é—á–∞–µ—Ç —ç—Ç–æ—Ç —Ñ–∞–π–ª –∫–∞–∫ —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ st.Page().
"""

import streamlit as st
import pandas as pd
import json
from io import BytesIO

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à—É –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
from src.services.content_gen import generate_content_plan

def render_plan_tab():
    st.title("üìÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞")
    st.markdown("–°–æ–∑–¥–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü —Å —É—á–µ—Ç–æ–º –≤–∞—à–µ–π –Ω–∏—à–∏ –∏ –∫–∞–Ω–∞–ª–æ–≤.")

    # –†–∞–∑–¥–µ–ª—è–µ–º —ç–∫—Ä–∞–Ω –Ω–∞ –∫–æ–ª–æ–Ω–∫—É —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏ –∫–æ–ª–æ–Ω–∫—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
    col1, col2 = st.columns([1, 2])

    with col1:
        st.subheader("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞–Ω–∞")
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ä–º—É, —á—Ç–æ–±—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–ª—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∫–ª–∏–∫–µ
        with st.form("content_plan_form"):
            # –ë–µ—Ä–µ–º –Ω–∏—à—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ session_state (–º—ã –∑–∞–¥–∞–ª–∏ –µ–µ –≤ main.py)
            niche = st.text_input(
                "–ù–∏—à–∞ –±–∏–∑–Ω–µ—Å–∞", 
                value=st.session_state.get("current_niche", "–ö–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ü–û")
            )
            
            period = st.selectbox("–ü–µ—Ä–∏–æ–¥", ["1 –Ω–µ–¥–µ–ª—è", "2 –Ω–µ–¥–µ–ª–∏", "1 –º–µ—Å—è—Ü"])
            
            channels = st.multiselect(
                "–ö–∞–Ω–∞–ª—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏",
                ["Telegram", "Email", "VK", "MAX", "–ë–ª–æ–≥"],
                default=["Telegram", "Email"]
            )
            
            extra_context = st.text_area(
                "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏–ª–∏ —Ç–µ–º—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–¥–µ–ª–∞—Ç—å –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –Ω–æ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö AI, —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ –∫–µ–π—Å —Å –±–∞–Ω–∫–æ–º..."
            )
            
            submit_btn = st.form_submit_button("‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω", width="stretch")

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
    if submit_btn:
        if not channels:
            st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–∞–Ω–∞–ª –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.")
        else:
            with col2:
                with st.spinner("üß† AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∏—à—É –∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–ª–∞–Ω..."):
                    try:
                        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
                        channels_str = ", ".join(channels)
                        
                        # –í—ã–∑—ã–≤–∞–µ–º –Ω–∞—à —Å–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                        plan_items = generate_content_plan(
                            niche=niche,
                            period=period,
                            channels=channels_str,
                            extra_context=extra_context
                        )
                        
                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Å–µ—Å—Å–∏—é
                        st.session_state.content_plan = [item.model_dump() for item in plan_items]
                        st.session_state.current_niche = niche
                        
                        # –≠–∫—Å—Ç—Ä–∞–≥–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã –¥–ª—è –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫ (—Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó)
                        unique_topics = list(set([item.topic for item in plan_items]))
                        st.session_state.generated_topics = unique_topics
                        
                        st.success("–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!")
                        
                    except Exception as e:
                        st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {str(e)}")

    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ —Å–µ—Å—Å–∏–∏)
    with col2:
        if st.session_state.get("content_plan"):
            st.subheader("–í–∞—à –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω")
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –≤ pandas DataFrame –¥–ª—è —É–¥–æ–±–Ω–æ–π —Ä–∞–±–æ—Ç—ã
            df = pd.DataFrame(st.session_state.content_plan)
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –Ω–µ–¥–µ–ª—è–º –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∫–∞–∫ –æ–±—Å—É–∂–¥–∞–ª–∏: expanders)
            weeks = df['week'].unique()
            for week in sorted(weeks):
                with st.expander(f"–ù–µ–¥–µ–ª—è {week}", expanded=(week==1)):
                    week_data = df[df['week'] == week]
                    
                    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –≤—ã–≤–æ–¥–∞
                    display_df = week_data[['day', 'topic', 'channel', 'format']].rename(
                        columns={
                            'day': '–î–µ–Ω—å', 
                            'topic': '–¢–µ–º–∞', 
                            'channel': '–ö–∞–Ω–∞–ª', 
                            'format': '–§–æ—Ä–º–∞—Ç'
                        }
                    )
                    st.dataframe(display_df, width="stretch", hide_index=True)

            # –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
            st.markdown("---")
            col_exp1, col_exp2 = st.columns(2)
            
            # –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
            csv = df.to_csv(index=False).encode('utf-8-sig')
            with col_exp1:
                st.download_button(
                    label="üìä –°–∫–∞—á–∞—Ç—å –∫–∞–∫ CSV",
                    data=csv,
                    file_name="content_plan.csv",
                    mime="text/csv",
                    width="stretch"
                )
                
            # –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
            json_str = json.dumps(st.session_state.content_plan, ensure_ascii=False, indent=2)
            with col_exp2:
                st.download_button(
                    label="üíª –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ JSON",
                    data=json_str,
                    file_name="content_plan.json",
                    mime="application/json",
                    width="stretch"
                )

# –ó–∞–ø—É—Å–∫ —Ä–µ–Ω–¥–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
render_plan_tab()