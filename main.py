"""
–ü—Ä–æ–µ–∫—Ç: GigaChat_Content_Assistant
–í–µ—Ä—Å–∏—è: 1.0
–°—Ç–∞—Ç—É—Å: –ü–µ—Ä–≤–∞—è deploy –≤–µ—Ä—Å–∏—è

–ú–æ–¥—É–ª—å: main.py
–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: GEN AI + @AI_NeuroStaff / Dubinin Vladimir


–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞) –¥–ª—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É Streamlit, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é —Å—Ç—Ä–∞–Ω–∏—Ü (st.navigation),
—Å—Ç–∏–ª–∏–∑–∞—Ü–∏—é –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (Glassmorphism) –∏ –≥–ª–æ–±–∞–ª—å–Ω—É—é –∑–∞—â–∏—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–æ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (session_state).
- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö CSS-—Å—Ç–∏–ª–µ–π.
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å–∫—Ä—ã—Ç–∏–µ –≤—Å–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –¥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞).
- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–Ω–æ–≥–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é (–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω, –†–∞—Å—Å—ã–ª–∫–∏, –õ–∏–¥-–º–∞–≥–Ω–∏—Ç—ã, SEO, –ù–∞—Å—Ç—Ä–æ–π–∫–∏).

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
- –í–Ω–µ—à–Ω–∏–µ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ): st.session_state —Ö—Ä–∞–Ω–∏—Ç –∫–ª—é—á–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏:
    - content_plan: —Ç–µ–∫—É—â–∏–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω.
    - generated_topics: —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–º (–¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏).
    - current_niche: —Ç–µ–∫—É—â–∞—è –Ω–∏—à–∞ –±–∏–∑–Ω–µ—Å–∞.
    - authentication_status, name: —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ—Ç streamlit-authenticator).
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ (–ª–æ–∫–∞–ª—å–Ω—ã–µ): 
    - authenticator: –∏–Ω—Å—Ç–∞–Ω—Å –æ–±—ä–µ–∫—Ç–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
    - plan_page, broadcast_page, lead_page, longread_page, settings_page: –æ–±—ä–µ–∫—Ç—ã st.Page –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.
    - pg: –æ–±—ä–µ–∫—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä–∞ st.navigation.

–§—É–Ω–∫—Ü–∏–∏:
- init_session_state() -> None
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ st.session_state, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –æ—à–∏–±–∫–∏ (KeyError)
    –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫.
- load_css() -> None
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞ assets/style.css, –∑–∞–≥—Ä—É–∂–∞–µ—Ç –µ–≥–æ –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç 
    –∫–∞—Å—Ç–æ–º–Ω—ã–µ CSS-—Å—Ç–∏–ª–∏ (—ç—Ñ—Ñ–µ–∫—Ç Glassmorphism) —Å –ø–æ–º–æ—â—å—é st.markdown.

–°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏:
- src.core.auth:
    - get_authenticator(): –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
- src.views.* (–í–∫–ª–∞–¥–∫–∏ UI):
    - plan_tab.py, broadcast_tab.py, lead_tab.py, longread_tab.py, settings_tab.py:
      –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ st.navigation.
- assets/:
    - style.css: —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

–¢—Ä–µ–±—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–≤ .env –∏–ª–∏ .streamlit/secrets.toml):
- SETTINGS_USERNAME : –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ.
- SETTINGS_PASSWORD : –ü–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ.
- AUTH_COOKIE_KEY   : –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ cookie-—Ñ–∞–π–ª–æ–≤.
"""

import os 
import streamlit as st

# ==========================================
# 1. –ù–ê–°–¢–†–û–ô–ö–ê –°–¢–†–ê–ù–ò–¶–´ (–í—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Ä–≤–æ–π –∫–æ–º–∞–Ω–¥–æ–π!)
# ==========================================
st.set_page_config(
    page_title="Content AI Assistant",
    page_icon="‚ú®",
    layout="wide",
    initial_sidebar_state="expanded"
)

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –º–æ–¥—É–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
from src.core.auth import get_authenticator

# ==========================================
# 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–û–°–¢–û–Ø–ù–ò–Ø
# ==========================================
def init_session_state():
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ st.session_state, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è
    –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏.
    –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–ª—é—á–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –∫ –Ω–∏–º –æ–±—Ä–∞—Ç—è—Ç—Å—è –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏.
    """
    if "content_plan" not in st.session_state:
        st.session_state.content_plan = []
    if "generated_topics" not in st.session_state:
        st.session_state.generated_topics = []
    if "current_niche" not in st.session_state:
        st.session_state.current_niche = "–ö–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ü–û"

init_session_state()

# ==========================================
# 3. –ó–ê–ì–†–£–ó–ö–ê CSS (Glassmorphism & Branding)
# ==========================================
def load_css():
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–µ CSS-—Å—Ç–∏–ª–∏ (—ç—Ñ—Ñ–µ–∫—Ç Glassmorphism) –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞ assets/style.css.
    –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤—ã–≤–æ–¥–∏—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–∏–∑–∞–π–Ω Streamlit.
    """
    css_path = os.path.join("assets", "style.css")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –ø–∞–¥–∞–ª–æ, –µ—Å–ª–∏ –≤—ã –∑–∞–±—É–¥–µ—Ç–µ –µ–≥–æ –ø–æ–ª–æ–∂–∏—Ç—å
    if os.path.exists(css_path):
        with open(css_path, "r", encoding="utf-8") as f:
            st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)
    else:
        st.warning("–§–∞–π–ª —Å—Ç–∏–ª–µ–π assets/style.css –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–∏–∑–∞–π–Ω.")

# –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é
load_css()

# ==========================================
# 4. –ë–õ–û–ö –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
# ==========================================
authenticator = get_authenticator()

# –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ª–æ–≥–∏–Ω–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É —ç–∫—Ä–∞–Ω–∞ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
authenticator.login()

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
if st.session_state.get("authentication_status"):
# ==========================================
# 5. –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï (–¢–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö)
# ==========================================
    
    # –û—Ñ–æ—Ä–º–ª—è–µ–º —Å–∞–π–¥–±–∞—Ä –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ö–æ–¥–∞
    with st.sidebar:
        st.title("‚ú® Content AI")
        st.caption("Liquid Glass Edition")
        st.write(f"üë§ –ü—Ä–∏–≤–µ—Ç, **{st.session_state.get('name', '–ê–¥–º–∏–Ω')}**!")
        
        # –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –≤ —Å–∞–π–¥–±–∞—Ä–µ
        authenticator.logout("üö™ –í—ã–π—Ç–∏", "sidebar")
        st.markdown("---")

    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    plan_page = st.Page("src/views/plan_tab.py", title="–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω", icon="üìÖ", default=True)
    broadcast_page = st.Page("src/views/broadcast_tab.py", title="–†–∞—Å—Å—ã–ª–∫–∏", icon="‚úâÔ∏è")
    lead_page = st.Page("src/views/lead_tab.py", title="–ú–æ—Ä–∫–æ–≤–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞", icon="üéÅ")
    longread_page = st.Page("src/views/longread_tab.py", title="–õ–æ–Ω–≥—Ä–∏–¥—ã / SEO", icon="üìù")
    settings_page = st.Page("src/views/settings_tab.py", title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏", icon="‚öôÔ∏è")

    # –°–æ–±–∏—Ä–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
    pg = st.navigation(
        {
            "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞": [plan_page, broadcast_page, lead_page, longread_page],
            "–°–∏—Å—Ç–µ–º–∞": [settings_page]
        }
    )
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    pg.run()

elif st.session_state.get("authentication_status") is False:
    # –í–≤–µ–¥–µ–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å
    st.error("‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å.")

elif st.session_state.get("authentication_status") is None:
    # –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–æ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö)
    st.info("üîí –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ.")